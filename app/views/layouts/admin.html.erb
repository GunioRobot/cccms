<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  
    <title><%= "#{params[:controller]} | #{params[:action]}" %></title>
    <%= stylesheet_link_tag 'admin' %>
    <%= javascript_include_tag 'jquery-1.3.2.min' %>
    <%= javascript_include_tag 'tiny_mce/tiny_mce.js' %>
    <%= javascript_include_tag 'admin_interface.js' %>
    
    <script type="text/javascript">
      tinyMCE.init({
        theme: "advanced",
        mode : "specific_textareas",
        editor_selector : "with_editor",
        theme_advanced_toolbar_location : "top",
        theme_advanced_toolbar_align : "left",
        theme_advanced_buttons1 : "bold, italic, underline, bullist, numlist, link, unlink, formatselect, code",
        theme_advanced_buttons2 : "",
        theme_advanced_buttons3 : "",
        extended_valid_elements : "aggregate[tags|limit|order_by|order_direction|partial]",
        relative_urls : false,
        entity_encoding : "raw",
        oninit : "setup_autosave"
      });
      
      var setup_autosave = function() {
        
        var elements = {
          "title"    : $('#page_title'),
          "abstract" : $('#page_abstract'),
          "body"     : $('#page_body_ifr').contents().find('#tinymce'),
        }
        
        
        var page = {         
          "cached_title_length"    : elements.title.val().length,
          "cached_abstract_length" : elements.abstract.val().length,
          "cached_body_length"     : elements.body.html().length,
      
          "title_has_changed" : function() {
             return (elements.title.val().length != this.cached_title_length)
           },
           
           "abstract_has_changed" : function() {
             return (elements.abstract.val().length != this.cached_abstract_length)
           },
           
           "body_has_changed" : function() {
             return elements.body.html().length != this.cached_body_length
           }
        }
        
        
        jQuery.fn.submitWithAjax = function(options) {
          if (page.title_has_changed() || page.abstract_has_changed() || page.body_has_changed()) {
            
            page.cached_title_length      =  elements.title.val().length;
            page.cached_abstract_length   = elements.abstract.val().length;
            page.cached_body_length       = elements.body.html().length;
            
            $("#flash").append("<img src='/images/ajax-loader.gif' alt='' />");
            $.post(this.attr("action"), $(this).serialize(), null, "script");
          }
        };
      }
    </script>
  </head>
  
  <body>
    <div id="wrapper">
      <div id="navigation">
        <%= render :partial => 'admin/menu' if current_user %>
      </div>
      <div id="subnavigation">
        <%= yield :subnavigation %>
      </div>
      <div style="clear: both"></div>
      <div id="flash">
        <%= flash[:notice] %>
      </div>
      <div id="content">
        <%= yield :layout %>
      </div>
    </div>
  </body>
</html>
